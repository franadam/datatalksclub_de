# ğŸš€ **Orchestration â€“ Kestra**

### *DataTalksClub - Data Engineering Zoomcamp 2025*

> **Automating and Managing Data Pipelines with Kestra and AWS Athena**  

This readme contains my notes and key takeaways from **Module 2 â€“ Workflow Orchestration** of the **DataTalksClub Data Engineering Zoomcamp 2025**. In this module, I explored **Kestra**, focusing on orchestrating workflows for AWS Athena while leveraging Iceberg and External tables.

---

## **ğŸ“Œ What is Workflow Orchestration?**
Workflow orchestration automates data workflows, ensuring tasks **execute in the correct sequence** while handling dependencies and failures. In this module, we used **Kestra**, a **cloud-native orchestrator**, to manage AWS Athena queries.

### **Why Use Kestra?**
âœ… **Declarative YAML-Based Workflows** â€“ Define workflows using a **code-first approach**  
âœ… **Built-in AWS Integrations** â€“ Supports S3, Athena, Glue, Lambda, and more  
âœ… **Event-Driven Triggers** â€“ Automate workflows with **scheduled or event-based** triggers  
âœ… **Scalable & Cloud-Native** â€“ Designed for distributed and fault-tolerant execution  


# **ğŸ“Œ AWS Athena & Table Types**
AWS Athena is a **serverless query service** that allows analyzing structured and semi-structured data stored in **Amazon S3** using **SQL (Presto/Trino engine).**  

Athena supports multiple table types, including **Iceberg tables** and **External tables**, each with distinct use cases.


## **ğŸ§Š What is an Iceberg Table?**
**Apache Iceberg** is an open-source table format designed for large-scale analytics. Iceberg tables in Athena provide **ACID transactions**, **time travel**, and **schema evolution**, making them suitable for data warehouses.

### **ğŸ” Features of Iceberg Tables**
âœ” **ACID Transactions** â€“ Supports **INSERT, UPDATE, DELETE** operations  
âœ” **Schema Evolution** â€“ Allows adding or modifying columns **without rewriting data**  
âœ” **Time Travel** â€“ Query historical snapshots of data  
âœ” **Partition Evolution** â€“ Update partitioning strategy without reloading data  

### **ğŸ› ï¸ Creating an Iceberg Table in AWS Athena**
```sql
CREATE TABLE IF NOT EXISTS {{ kv('AWS_ATHENA_DATABASE') }}.{{inputs.taxi}}_tripdata_iceberg (
  unique_row_id binary            COMMENT 'A unique identifier for the trip, generated by hashing key trip attributes.',
  filename string                 COMMENT 'The source filename from which the trip data was loaded.',
  VendorID string                 COMMENT 'A code indicating the LPEP provider that provided the record. 1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.',
  tpep_pickup_datetime timestamp  COMMENT 'The date and time when the meter was engaged',
  tpep_dropoff_datetime timestamp COMMENT 'The date and time when the meter was disengaged',
  passenger_count int             COMMENT 'The number of passengers in the vehicle. This is a driver-entered value.',
  trip_distance double            COMMENT 'The elapsed trip distance in miles reported by the taximeter.',
  RatecodeID string               COMMENT 'The final rate code in effect at the end of the trip. 1= Standard rate 2=JFK 3=Newark 4=Nassau or Westchester 5=Negotiated fare 6=Group ride',
  store_and_fwd_flag string       COMMENT 'This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka "store and forward," because the vehicle did not have a connection to the server. Y= store and forward trip N= not a store and forward trip',
  PULocationID string             COMMENT 'TLC Taxi Zone in which the taximeter was engaged',
  DOLocationID string             COMMENT 'TLC Taxi Zone in which the taximeter was disengaged',
  payment_type int                COMMENT 'A numeric code signifying how the passenger paid for the trip. 1= Credit card 2= Cash 3= No charge 4= Dispute 5= Unknown 6=Voided trip',
  fare_amount double              COMMENT 'The time-and-distance fare calculated by the meter',
  extra double                    COMMENT 'Miscellaneous extras and surcharges. Currently, this only includes the $0.50 and $1 rush hour and overnight charges',
  mta_tax double                  COMMENT '$0.50 MTA tax that is automatically triggered based on the metered rate in use',
  tip_amount double               COMMENT 'Tip amount. This field is automatically populated for credit card tips. Cash tips are not included.',
  tolls_amount double             COMMENT 'Total amount of all tolls paid in trip.',
  improvement_surcharge double    COMMENT '$0.30 improvement surcharge assessed on hailed trips at the flag drop. The improvement surcharge began being levied in 2015.',
  total_amount double             COMMENT 'The total amount charged to passengers. Does not include cash tips.',
  congestion_surcharge double     COMMENT 'Congestion surcharge applied to trips in congested zones',
  airport_fee double              COMMENT '$1.25 for pick up only at LaGuardia and John F. Kennedy Airports'
)
COMMENT '{{inputs.taxi}}_tripdata with description'
LOCATION 's3://{{kv('AWS_BUCKET_NAME')}}/{{inputs.taxi}}/tables/iceberg'
TBLPROPERTIES (
  'table_type'='ICEBERG',
  'format'='parquet',
  'write_compression'='snappy'
);
```



## **ğŸ“ What is an External Table?**
An **External Table** in AWS Athena is a **logical table definition** that references **raw data stored in S3**. Unlike Iceberg tables, **external tables do not manage metadata changes** (e.g., schema evolution).

### **ğŸ” Features of External Tables**
âœ” **Read-Only Structure** â€“ Cannot perform **INSERT, UPDATE, DELETE**  
âœ” **Schema-on-Read** â€“ Data remains in **S3 as raw files** (e.g., **CSV, Parquet, ORC**)  
âœ” **Cost-Effective** â€“ **No storage costs** in Athena (only pay for query scans)  

### **ğŸ› ï¸ Creating an External Table in AWS Athena**
```sql
CREATE EXTERNAL TABLE IF NOT EXISTS {{ render(vars.table) }}_ext (
  VendorID string                 COMMENT 'A code indicating the LPEP provider that provided the record. 1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.',
  tpep_pickup_datetime timestamp  COMMENT 'The date and time when the meter was engaged',
  tpep_dropoff_datetime timestamp COMMENT 'The date and time when the meter was disengaged',
  passenger_count int             COMMENT 'The number of passengers in the vehicle. This is a driver-entered value.',
  trip_distance double            COMMENT 'The elapsed trip distance in miles reported by the taximeter.',
  RatecodeID string               COMMENT 'The final rate code in effect at the end of the trip. 1= Standard rate 2=JFK 3=Newark 4=Nassau or Westchester 5=Negotiated fare 6=Group ride',
  store_and_fwd_flag string       COMMENT 'This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka "store and forward," because the vehicle did not have a connection to the server. Y= store and forward trip N= not a store and forward trip',
  PULocationID string             COMMENT 'TLC Taxi Zone in which the taximeter was engaged',
  DOLocationID string             COMMENT 'TLC Taxi Zone in which the taximeter was disengaged',
  payment_type int                COMMENT 'A numeric code signifying how the passenger paid for the trip. 1= Credit card 2= Cash 3= No charge 4= Dispute 5= Unknown 6=Voided trip',
  fare_amount double              COMMENT 'The time-and-distance fare calculated by the meter',
  extra double                    COMMENT 'Miscellaneous extras and surcharges. Currently, this only includes the $0.50 and $1 rush hour and overnight charges',
  mta_tax double                  COMMENT '$0.50 MTA tax that is automatically triggered based on the metered rate in use',
  tip_amount double               COMMENT 'Tip amount. This field is automatically populated for credit card tips. Cash tips are not included.',
  tolls_amount double             COMMENT 'Total amount of all tolls paid in trip.',
  improvement_surcharge double    COMMENT '$0.30 improvement surcharge assessed on hailed trips at the flag drop. The improvement surcharge began being levied in 2015.',
  total_amount double             COMMENT 'The total amount charged to passengers. Does not include cash tips.',
  congestion_surcharge double     COMMENT 'Congestion surcharge applied to trips in congested zones',
  airport_fee double              COMMENT '$1.25 for pick up only at LaGuardia and John F. Kennedy Airports'
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES ('field.delim' = ',', 'skip.header.line.count'='1')
STORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION 's3://{{kv('AWS_BUCKET_NAME')}}/{{inputs.taxi}}/csv/'
TBLPROPERTIES ('classification' = 'csv');
```



## **ğŸ†š When to Use Iceberg vs. External Tables?**
| Feature           | Iceberg Table | External Table |
|------------------|--------------|---------------|
| **ACID Transactions** | âœ… Yes | âŒ No |
| **Schema Evolution** | âœ… Yes | âŒ No |
| **Time Travel** | âœ… Yes | âŒ No |
| **Insert/Update/Delete** | âœ… Yes | âŒ No |
| **Storage Cost** | **Higher** (manages metadata) | **Lower** (only raw files in S3) |
| **Best Use Case** | **Data Warehousing, Slowly Changing Data** | **Raw Data Exploration, Temporary Analysis** |

### **ğŸ“Œ Summary**
- **Use Iceberg Tables** if you need **mutability (INSERT, UPDATE, DELETE)** and **schema evolution**.  
- **Use External Tables** when working with **static datasets in S3** where **schema does not change**.  

---

## **ğŸ“‹ Best Practices for AWS Athena & Kestra**
âœ… **Use Parquet/ORC over CSV** â€“ Columnar formats reduce query costs  
âœ… **Partition Data Smartly** â€“ Avoid excessive small partitions for performance  
âœ… **Use Iceberg for Large-Scale Data Warehouses** â€“ Enables better **data management and querying**  
âœ… **Limit SELECT \*** â€“ Always select specific columns to **reduce scanned data**  
âœ… **Monitor Query Costs** â€“ Use `EXPLAIN` before running expensive queries  
âœ… **Leverage Kestra for Automation** â€“ Use **triggers** to automate table refresh and ingestion  

## **ğŸ“Œ Key Takeaways**
ğŸ”¹ **Athena Iceberg Tables** allow **ACID transactions, schema evolution, and time travel**  
ğŸ”¹ **External Tables** are read-only and reference **raw data stored in S3**  
ğŸ”¹ **Use Kestra to automate workflows** for data ingestion, processing, and querying  
ğŸ”¹ **Optimize queries using Parquet format, partitioning, and limiting data scans**  


## **ğŸ”œ Next Steps**
Now that I understand **Athena and Kestra**, my next step is to explore **data wharehousing**. ğŸš€  


## **ğŸ“š Additional Resources**
ğŸ“– AWS Athena Docs: [ğŸ”— Link](https://docs.aws.amazon.com/athena/latest/ug/what-is.html)  
ğŸ“– Apache Iceberg Docs: [ğŸ”— Link](https://iceberg.apache.org/)  
ğŸ“– Kestra Orchestration Docs: [ğŸ”— Link](https://kestra.io/docs/)  
